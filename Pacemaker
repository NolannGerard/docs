Je vais te prÃ©parer TOUT le TP, entiÃ¨rement propre, en blocs prÃªts Ã  copier-coller, sans bla-bla.

âœ… Cluster Pacemaker
âœ… Apache en actif/actif
âœ… MariaDB (dÃ©jÃ  fait)
âœ… HAProxy HTTP
âœ… HAProxy statistiques
âœ… HAProxy HTTPS
âœ… Redirection HTTP â†’ HTTPS
âœ… Correction Apache2 pour dÃ©sactiver HTTPS
âœ… Pages web diffÃ©rentes sur serv1 et serv2

Tout sera prÃªt Ã  copier-coller directement dans tes fichiers.

âœ… 1) PACEMAKER â€” Conversion du service Apache2 en actif/actif

ðŸ“Œ Sur serv1

ðŸ‘‰ Copier-coller :

crm resource stop serviceWeb
crm resource stop IPFailover
crm configure delete servweb
crm resource start IPFailover
crm configure clone cServiceWeb serviceWeb
crm resource start serviceWeb

âœ… 2) MARIADB â€” Configuration anti-collision auto_increment

âœ… sur serv1

echo "auto_increment_offset = 1" >> /etc/mysql/mariadb.conf.d/50-server.cnf
echo "auto_increment_increment = 2" >> /etc/mysql/mariadb.conf.d/50-server.cnf


âœ… sur serv2

echo "auto_increment_offset = 2" >> /etc/mysql/mariadb.conf.d/50-server.cnf
echo "auto_increment_increment = 2" >> /etc/mysql/mariadb.conf.d/50-server.cnf


âœ… RedÃ©marrage :

systemctl restart mariadb

âœ… 3) APACHE2 â€” DÃ©sactiver HTTPS & activer uniquement HTTP

ðŸ“Œ Fichier /etc/apache2/sites-available/sodecaf.conf sur serv1 et serv2

ðŸ‘‰ Supprime entiÃ¨rement toute la partie <VirtualHost *:443> ... </VirtualHost>
ðŸ‘‰ Ne laisse que ceci :

<VirtualHost *:80>
    DocumentRoot /var/www/html
    ServerName sodecaf.local
</VirtualHost>


Ensuite :

a2dissite default-ssl.conf
a2enmod ssl
systemctl restart apache2

âœ… 4) Pages web diffÃ©rentes sur serv1 et serv2

âœ… serv1 :

echo "<h1>Accueil1</h1>" > /var/www/html/index.html


âœ… serv2 :

echo "<h1>Accueil2</h1>" > /var/www/html/index.html

âœ… 5) Installation dâ€™HAProxy (sur la VM Debian 12)
apt update
apt install -y haproxy

âœ… 6) HAProxy HTTP â€” Configuration simple

ðŸ“Œ Fichier : /etc/haproxy/haproxy.cfg

ðŸ‘‰ Efface tout et remplace par :

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000
    timeout client 50000
    timeout server 50000

frontend proxypublic
    bind 172.16.0.13:80
    default_backend fermeweb

backend fermeweb
    balance roundrobin
    option httpclose
    option httpchk HEAD / HTTP/1.0
    server serv1 192.168.0.1:80 check
    server serv2 192.168.0.2:80 check

listen stats
    bind 172.16.0.13:8080
    stats uri /statsHaproxy
    stats auth root:Btssio2017
    stats refresh 30s


âœ… RedÃ©marrage :

systemctl restart haproxy

âœ… 7) HAProxy avec serveurs de puissance inÃ©gale (serv2 3x plus faible)

ðŸ‘‰ Modifier uniquement le backend :

backend fermeweb
    balance roundrobin
    option httpclose
    option httpchk HEAD / HTTP/1.0
    server serv1 192.168.0.1:80 weight 3 check
    server serv2 192.168.0.2:80 weight 1 check


âœ… RedÃ©marrage :

systemctl restart haproxy

âœ… 8) HAProxy â€” Activer HTTPS cÃ´tÃ© frontend

âœ… CrÃ©ation du certificat :

apt install -y openssl
mkdir -p /etc/haproxy/cert
cd /etc/haproxy/cert
openssl genrsa -out privateKey.pem 4096
openssl req -new -x509 -days 365 -key privateKey.pem -out cert.pem -subj "/CN=sodecaf"
cat cert.pem privateKey.pem > sodecaf.pem


âœ… Ajouter dans /etc/haproxy/haproxy.cfg :

frontend https-in
    bind 172.16.0.13:443 ssl crt /etc/haproxy/cert/sodecaf.pem
    default_backend fermeweb


âœ… RedÃ©marrer :

systemctl restart haproxy

âœ… 9) Redirection HTTP â†’ HTTPS

Dans frontend proxypublic, remplacer tout par :

frontend proxypublic
    bind 172.16.0.13:80
    http-request redirect scheme https unless { ssl_fc }
    default_backend fermeweb


âœ… RedÃ©marrage :

systemctl restart haproxy

âœ… 10) Test de configuration HAProxy
haproxy -c -f /etc/haproxy/haproxy.cfg
